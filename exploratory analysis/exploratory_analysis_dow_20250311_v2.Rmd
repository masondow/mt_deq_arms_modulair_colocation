---
title: "Exploratory Analysis of Montana PM2.5 Collocation Data"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

# Introduction

This document performs an exploratory analysis of collocation datasets from FEM sites (RP, NC, and LT). The objectives are to:

- Generate summary tables of descriptive statistics (min, max, mean, standard deviation, etc.) for each parameter for each site.
- Visualize PM2.5 trends 
- Compute AQI categories for PM2.5 using the AirMontitor package.
- Calculate a comprehensive set of accuracy metrics (including R², MAE, RMSE, normalized RMSE, regression slope, and intercept), overall and by AQI category.
- Validate the weighted average computation for the RP site, which uses static weights derived from the cube root of the inverse variance of the three FEM instruments (RP_1020, RP_1022, RP_thermo).

# Setup

```{r setup, message=FALSE, warning=FALSE}
# Load necessary libraries
library(tidyverse)
library(readxl)
library(lubridate)
library(scales)
library(knitr)

# Load the AirMontitor package for AQI categorization
library(AirMonitor)

# Set a consistent theme for ggplot2
theme_set(theme_minimal())
```


## Load Data

```{r}
# Load data from data folder 
lt_data <- read_excel("../data/LT_data.xlsx")
nc_data <- read_excel("../data/NC_data.xlsx")
rp_data <- read_excel("../data/RP_data.xlsx")
```

## Descriptive Statistics

```{r}
# Function to generate descriptive statistics table
descriptive_stats <- function(data) {
  data %>%
    summarise(across(where(is.numeric),
                     list(mean = ~mean(.x, na.rm = TRUE),
                          sd   = ~sd(.x, na.rm = TRUE),
                          min  = ~min(.x, na.rm = TRUE),
                          max  = ~max(.x, na.rm = TRUE)))) %>%
    pivot_longer(
      cols = everything(),
      names_to = c("parameter", ".value"),
      names_pattern = "(.+)_(mean|sd|min|max)$"
    )
}

# Generate descriptive stats for each site
rp_stats <- descriptive_stats(rp_data)
nc_stats <- descriptive_stats(nc_data)
lt_stats <- descriptive_stats(lt_data)

# Display the tables
kable(rp_stats, caption = "Descriptive Statistics - RP Site")
kable(nc_stats, caption = "Descriptive Statistics - NC Site")
kable(lt_stats, caption = "Descriptive Statistics - LT Site")


```

## Data Visualizations 

```{r}
monitor_colors <- c("1020" = "yellow", 
                    "1022" = "red", 
                    "Thermo" = "tan", 
                    "FEM Average" ="green",
                    "Modulair" = "orange", 
                    "PurpleAir" = "purple")
```

### Boxplots of PM2.5 Concentration Distributions

```{r}
# Prepare data for boxplot for rp site and recode sensor names

# RP site
rp_stacked <- rp_data %>% 
  select(datetime, rp_1020, rp_1022, rp_thermo, rp_fem_avg, rp_modulair_pm25, rp_purpleair_cf1) %>% 
  pivot_longer(-datetime, names_to = "monitor", values_to = "pm25") %>%
  mutate(monitor = case_when(
    monitor == "rp_1020" ~ "1020",
    monitor == "rp_1022" ~ "1022",
    monitor == "rp_thermo" ~ "Thermo",
    monitor == "rp_fem_avg" ~ "FEM Average",
    monitor == "rp_modulair_pm25" ~ "Modulair",
    monitor == "rp_purpleair_cf1" ~ "PurpleAir",
    TRUE ~ monitor
  ))

ggplot(rp_stacked, aes(x = monitor, y = pm25, fill = monitor)) +
  geom_boxplot() +
  scale_fill_manual(values = monitor_colors) +
  labs(title = "PM2.5 Distribution at RP Site",
       x = "Monitor",
       y = "PM2.5 (µg/m³)") +
  theme(legend.position = "none")

# NC site 
nc_stacked <- nc_data %>% 
  select(datetime, nc_1020, nc_modulair_pm25, nc_purpleair_cf1) %>% 
  pivot_longer(-datetime, names_to = "monitor", values_to = "pm25") %>%
  mutate(monitor = case_when(
    monitor == "nc_1020" ~ "1020",
    monitor == "nc_modulair_pm25" ~ "Modulair",
    monitor == "nc_purpleair_cf1" ~ "PurpleAir",
    TRUE ~ monitor
  ))

ggplot(nc_stacked, aes(x = monitor, y = pm25, fill = monitor)) +
  geom_boxplot() +
  scale_fill_manual(values = monitor_colors) +
  labs(title = "PM2.5 Distribution at NC Site",
       x = "Monitor",
       y = "PM2.5 (µg/m³)") +
  theme(legend.position = "none")

# LT site
lt_stacked <- lt_data %>% 
  select(datetime, lt_thermo, lt_modulair_pm25, lt_purpleair_cf1) %>% 
  pivot_longer(-datetime, names_to = "monitor", values_to = "pm25") %>%
  mutate(monitor = case_when(
    monitor == "lt_thermo" ~ "Thermo",
    monitor == "lt_modulair_pm25" ~ "Modulair",
    monitor == "lt_purpleair_cf1" ~ "PurpleAir",
    TRUE ~ monitor
  ))

ggplot(lt_stacked, aes(x = monitor, y = pm25, fill = monitor)) +
  geom_boxplot() +
  scale_fill_manual(values = monitor_colors) +
  labs(title = "PM2.5 Distribution at LT Site",
       x = "Monitor",
       y = "PM2.5 (µg/m³)") +
  theme(legend.position = "none")



```

### Time Series Line Graphs of PM2.5 Concentration Distributions 

```{r}
# rp site 
ggplot(rp_data, aes(x = datetime)) +
  geom_line(aes(y = rp_1020, color = "1020")) +
  geom_line(aes(y = rp_1022, color = "1022")) +
  geom_line(aes(y = rp_thermo, color = "Thermo")) +
  geom_line(aes(y = rp_modulair_pm25, color = "Modulair")) +
  geom_line(aes(y = rp_purpleair_cf1, color = "PurpleAir")) +
  scale_color_manual(values = monitor_colors) +
  labs(title = "PM2.5 Time Series at RP Site",
       x = "Datetime",
       y = "PM2.5 (µg/m³)",
       color = "Monitor Type")

# nc site 
ggplot(nc_data, aes(x = datetime)) +
  geom_line(aes(y = nc_1020, color = "1020")) +
  geom_line(aes(y = nc_modulair_pm25, color = "Modulair")) +
  geom_line(aes(y = nc_purpleair_cf1, color = "PurpleAir")) +
  scale_color_manual(values = monitor_colors) +
  labs(title = "PM2.5 Time Series at NC Site",
       x = "Datetime",
       y = "PM2.5 (µg/m³)",
       color = "Monitor Type")

# lt site 
ggplot(lt_data, aes(x = datetime)) +
  geom_line(aes(y = lt_thermo, color = "Thermo")) +
  geom_line(aes(y = lt_modulair_pm25, color = "Modulair")) +
  geom_line(aes(y = lt_purpleair_cf1, color = "PurpleAir")) +
  scale_color_manual(values = monitor_colors) +
  labs(title = "PM2.5 Time Series at LT Site",
       x = "Datetime",
       y = "PM2.5 (µg/m³)",
       color = "Monitor Type")

```


## Build AQI Categories across datasets/PM2.5 monitors 

```{r}
# For rp site:
rp_data <- rp_data %>%
  mutate(rp_modulair_aqi = aqiCategories(rp_modulair_pm25, pollutant = "PM2.5", NAAQS = "PM2.5_2024"),
         rp_purpleair_aqi = aqiCategories(rp_purpleair_cf1, pollutant = "PM2.5", NAAQS = "PM2.5_2024"),
         rp_fem_aqi = aqiCategories(rp_fem_avg, pollutant = "PM2.5", NAAQS = "PM2.5_2024"))

# For nc site:
nc_data <- nc_data %>%
  mutate(nc_modulair_aqi = aqiCategories(nc_modulair_pm25, pollutant = "PM2.5", NAAQS = "PM2.5_2024"),
         nc_purpleair_aqi = aqiCategories(nc_purpleair_cf1, pollutant = "PM2.5", NAAQS = "PM2.5_2024"),
         nc_fem_aqi = aqiCategories(nc_1020, pollutant = "PM2.5", NAAQS = "PM2.5_2024"))

# For lt site:
lt_data <- lt_data %>%
  mutate(lt_modulair_aqi = aqiCategories(lt_modulair_pm25, pollutant = "PM2.5", NAAQS = "PM2.5_2024"),
         lt_purpleair_aqi = aqiCategories(lt_purpleair_cf1, pollutant = "PM2.5", NAAQS = "PM2.5_2024"),
         lt_fem_aqi = aqiCategories(lt_thermo, pollutant = "PM2.5", NAAQS = "PM2.5_2024"))


```
 
 
## Accuracy Metrics

### Function Building

```{r}
# Function to calculate overall accuracy metrics
# FEM monitor measurement is treated as the independent (true) variable,
# and the Modulair monitor measurement under evaluation is treated as the dependent (predicted) variable, per EPA reccomendations. 

calculate_metrics <- function(true_values, predicted_values) {
  # Remove missing values
  valid_idx <- !is.na(true_values) & !is.na(predicted_values)
  true_vals <- true_values[valid_idx]
  pred_vals <- predicted_values[valid_idx]
  
  # Fit linear regression: predicted ~ true
  fit <- lm(pred_vals ~ true_vals)
  slope <- coef(fit)[2]
  intercept <- coef(fit)[1]
  r_squared <- summary(fit)$r.squared
  
  # Calculate residuals and error metrics
  residuals <- true_vals - pred_vals
  mae <- mean(abs(residuals))
  rmse <- sqrt(mean(residuals^2))
  nrmse <- rmse / mean(true_vals) * 100  # Expressed as percentage
  
  tibble(
    R_squared = r_squared,
    MAE = mae,
    RMSE = rmse,
    NRMSE = nrmse,
    Slope = slope,
    Intercept = intercept
  )
}

# Function to calculate all accuracy metrics:
# 1. Overall accuracy metrics
# 2. Stratified metrics by FEM AQI category
# 3. Frequency of matching AQI categories between the Modulair and FEM.

# Arguments:
# - data: data frame containing the data.
# - fem_col: column name (string) for the FEM monitor measurement (independent variable).
# - mod_col: column name (string) for the Modulair monitor measurement (dependent variable).
# - fem_aqi_col: column name for the FEM AQI category.
# - mod_aqi_col: column name for the Modulair AQI category.

calculate_all_metrics <- function(data, fem_col, mod_col, fem_aqi_col, mod_aqi_col) {
  # Overall accuracy metrics based on EPA recommendations:FEM measurement is true value, Modulair measurement is compared against it.
  
  overall <- calculate_metrics(data[[fem_col]], data[[mod_col]])
  
  # Calculate frequency of matching AQI categories between Modulair and FEM monitors
  aqi_match <- data %>%
    mutate(match = (.data[[mod_aqi_col]] == .data[[fem_aqi_col]])) %>%
    summarise(match_frequency = mean(match, na.rm = TRUE))
  
  # Add the AQI match frequency as a new column to the overall metrics
  overall <- overall %>% mutate(aqi_match_frequency = aqi_match$match_frequency)
  
  # Stratified metrics by FEM AQI category:
  stratified <- data %>%
    filter(!is.na(.data[[fem_aqi_col]])) %>%
    group_by(category = .data[[fem_aqi_col]]) %>%
    summarise(
      R_squared = if(n() > 1) cor(.data[[fem_col]], .data[[mod_col]], use = "complete.obs")^2 else NA_real_,
      MAE = mean(abs(.data[[fem_col]] - .data[[mod_col]]), na.rm = TRUE),
      RMSE = sqrt(mean((.data[[fem_col]] - .data[[mod_col]])^2, na.rm = TRUE)),
      NRMSE = (sqrt(mean((.data[[fem_col]] - .data[[mod_col]])^2, na.rm = TRUE)) / mean(.data[[fem_col]], na.rm = TRUE)) * 100,
      .groups = "drop"
    )
  
  return(list(overall = overall, stratified = stratified))
}

```


### Calculate accuracy metrics by site
 
```{r}

# apply accuracy metrics functions to all three datasets

datasets <- list(rp = rp_data, nc = nc_data, lt = lt_data)
results <- list()

# Define the column names 
col_info <- list(
  rp = list(fem = "rp_fem_avg", mod = "rp_modulair_pm25", fem_aqi = "rp_fem_aqi", mod_aqi = "rp_modulair_aqi"),
  nc = list(fem = "nc_1020", mod = "nc_modulair_pm25", fem_aqi = "nc_fem_aqi", mod_aqi = "nc_modulair_aqi"),
  lt = list(fem = "lt_thermo", mod = "lt_modulair_pm25", fem_aqi = "lt_fem_aqi", mod_aqi = "lt_modulair_aqi")
)

# Loop over each dataset and apply the function.
for (site in names(datasets)) {
  results[[site]] <- calculate_all_metrics(
    data = datasets[[site]],
    fem_col = col_info[[site]]$fem,
    mod_col = col_info[[site]]$mod,
    fem_aqi_col = col_info[[site]]$fem_aqi,
    mod_aqi_col = col_info[[site]]$mod_aqi
  )
}

# Build a single overall metrics table with each row representing a site
overall_table <- bind_rows(lapply(names(results), function(site) {
  results[[site]]$overall %>% mutate(site = site)
}))
overall_table <- overall_table %>% select(site, everything())

# Print the overall metrics table
kable(overall_table, caption = "Overall Accuracy Metrics by Site (FEM vs. Modulair)")

# Print stratified metrics for each site using kable
for (site in names(results)) {
  print(kable(results[[site]]$stratified, caption = paste("Accuracy Metrics by AQI Category -", site, "Site")))
}

```
 
### Create combined dataset 
 
```{r}
# Combine the datasets 

rp_combined <- rp_data %>%
  rename(
    fem_avg = rp_fem_avg,
    mod = rp_modulair_pm25,
    fem_aqi = rp_fem_aqi,
    mod_aqi = rp_modulair_aqi
  )

nc_combined <- nc_data %>%
  rename(
    fem_avg = nc_1020,
    mod = nc_modulair_pm25,
    fem_aqi = nc_fem_aqi,
    mod_aqi = nc_modulair_aqi
  )

lt_combined <- lt_data %>%
  rename(
    fem_avg = lt_thermo,
    mod = lt_modulair_pm25,
    fem_aqi = lt_fem_aqi,
    mod_aqi = lt_modulair_aqi
  )

combined_data <- bind_rows(rp_combined, nc_combined, lt_combined)


```

### calculate overall accuracy metrics 

```{r}
# apply accuracy metrics functions to combined dataset

combined_metrics <- calculate_all_metrics(
  data = combined_data,
  fem_col = "fem_avg",
  mod_col = "mod",
  fem_aqi_col = "fem_aqi",
  mod_aqi_col = "mod_aqi"
)

# Display the overall metrics for the combined dataset
print(combined_metrics$overall)

# Display the stratified accuracy metrics by AQI category for the combined dataset
kable(combined_metrics$stratified, caption = "Accuracy Metrics by AQI Category - Combined Data")
```

